<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>搜索页面</title>
    <link rel="stylesheet" href="./static/css/ace.min.css" />
    <link rel="stylesheet" type="text/css" href="./static/bootstrap-3.3.7-dist/css/bootstrap.css">
    <link rel="stylesheet" href="./static/css/commons.css">
    <link rel="stylesheet" href="./static/css/bootoast.css">

    <style>
        html{overflow-x:hidden; overflow-y:auto;}
        /* 注意，本题无需写样式清除 */
        .menu-container {
            width: 990px;
            height: 587px;
            padding-top: 25px;
            display: flex;
            flex-wrap: wrap;

        }

        .item {
            width: 180px;
            height: 250px;
            text-align: center;
            font-size: 12px;
            margin: 0 0 50px 50px;
        }

        .menu-banner {
            position: relative;
            margin-bottom: 10px;
            width: 200px;
            height: 250px;

            background-size: cover;
        }

        .menu-info {
            position: absolute;
            top: 150px;
            width:200px;

            left: 0;
        }
        /* 左侧8大菜系 */
        table {
            position: absolute;
            top: 0px;

        }





        /* 下拉菜单 */
        .classs {
            position: absolute;
            top: 10px;
            left: 380px;
        }



    </style>

</head>
<body>
<div class="container-fluid main" style="position: relative;">
    <div class="collapse navbar-collapse" id="example-navbar-collapse" style="width: 1460px;margin: auto;background-color: #c7f4b7;">
        <ul class="nav navbar-nav menulist navbar-left"  >
            <li><a href="index">首页</a></li>
            <li><a href="sortcook">菜单</a></li>
        </ul>

        <ul class="nav navbar-nav navbar-right " id="isLogin" style="width:10%;">

        </ul>

        <form  class="navbar-form navbar-right" role="search">
            <div class="form-group" style="height: 100%;margin-top: 0px">
                <label>
                    <input type="text" placeholder="请输入您要搜索的菜谱名称"  name="dishName" class="form-control searchinput" style="width: 224px;margin-top: 2px; border-radius: 15px!important;"/>
                </label>
                <a href="javascript:void (0)" style="color: #000;" class="searchimg">
                    <img  src="./static/images/icons/搜索.svg" alt="" class="searchimg tt"  >
                </a>
            </div>
        </form>
    </div>

    <div class="container">
        <div align=center  id="e">

    </div>
        <div align=center>

            <div class="ud">
                <div class="menu-container" id="regTa">



                </div>
            </div>
            </div>
        <div class="row" style="position:relative;top: 0px;left: 390px;height: 81px">

            <ul class="pagination" id="menuPage">
            </ul>

        </div>
        <div class="row" style="height: 100px;">
            <div class="footer" style="bottom: 0">
                <div class="row">
                    <div class="col-md-1 col-sm-3" style="height: 100px;"></div>
                    <div class="col-md-1 col-sm-3" style="height: 100px;width: 100px">
                        <img  src="./static/images/logo.png" alt="这是一个logo" style=" width: 74px; height: 88px; margin-top: 26px;margin-left: 19px">
                    </div>
                    <div class="col-md-5 col-sm-6" style="height: 100px;">
                        <p class="footer_link">网站首页&nbsp;&nbsp;&nbsp;帮助中心&nbsp;&nbsp;&nbsp;联系我们&nbsp;&nbsp;&nbsp;客户服务&nbsp;&nbsp;&nbsp;隐私政策
                            &nbsp;&nbsp;&nbsp;意见反馈</p>
                        <p>Copyright © 2020SUMMER All Rights Reserved.</p>
                    </div>
                    <div class="col-md-1 col-sm-1" style="height: 100px;"></div>

                    <div class="col-md-3 col-sm-4" style="height: 100px;    margin-top: 23px;">
                        <img class="pic qq"  src="./static/images/share/QQ.svg" alt="QQ">
                        <img class="pic"  src="./static/images/share/wechat.svg" alt="wechat">
                        <img class="pic"  src="./static/images/share/blog.svg" alt="blog">
                    </div>
                    <div class="col-md-2 col-sm-1"></div>
                </div>
            </div>
        </div>

    </div>

</div>
<script type="text/javascript"  src="./static/js/jquery-3.3.1.js"></script>
<script type="text/javascript"  src="./static/bootstrap-3.3.7-dist/js/bootstrap.js"></script>
<script   src="./static/js/bootoast.js"></script>
<script  src="./static/js/login.js"></script>
<script  src="./static/js/nav.js"></script>
    <script>
        let text;
        let pageSize=8
        $(function () {
            const args=getQueryStringArgs()
            text='%'+args.dishName+'%'
            $.ajax({
                url: 'dishes/fuzzySearch',
                method: 'post',
                data: {text,pageSize},
                dataType: 'JSON',
                success(data) {
                    if (data.result) {

                    let content = ''

                    data.data.forEach(el => {
                        if (el.picturesInfoList != undefined) {
                            content += ` <div class="item wx">
                        <div class="menu-banner">
                            <a href="menuDetail?dishId=${el.dishId}"><img src="${el.picturesInfoList[0].picAddress}" alt="数据库没图给你们看" style=" width: 200px;height: 140px;top: 0;position: absolute;left: 0" ></a>
                            <div class="menu-info" style="overflow:hidden;text-overflow:ellipsis;word-break:keep-all;white-space:nowrap;">
                                <a href="menuDetail?dishId=${el.dishId}">文章名:${el.dishName}</a>  <a href="">作者:${el.userId}</a>
                                <br>
                                时间: ${dateFormat(el.dishCreateTime)}
                                <br>
                                简介    ${el.dishIntro}
                                <br>
                            </div>
                        </div>
                    </div>`
                            $('#regTa').empty().html(content)

                        } else {
                            content += ` <div class="item wx">
                            <div class="menu-banner">
                            <a href="menuDetail?dishId=${el.dishId}"><img src="" alt="数据库没图给你们看" style=" width: 200px;height: 140px;top: 0;position: absolute;left: 0" ></a>
                                    <div class="menu-info" style="overflow:hidden;text-overflow:ellipsis;word-break:keep-all;white-space:nowrap;">
                                        <a href="menuDetail?dishId=${el.dishId}">文章名:${el.dishName}</a>  <a href="">作者:${el.userId}</a>
                                         <br>
                                        时间: ${dateFormat(el.dishCreateTime)}
                                        <br>
                                        简介    ${el.dishIntro}
                                        <br>

                                </div>
                            </div>
                        </div>`
                            $('#regTa').empty().html(content)

                        }
                    })
                    let t = data.page.totalPage

                    const {totalPage, currPage} = data.page;
                    let pag = `        <li><a href="javascript:"
                                       data-curr-page="${currPage - 1 > 0 ? currPage - 1 : 1}"
                                       class="page">&laquo;</a></li>
				                <li><a href="javascript:" data-curr-page="1" class="page">首页</a></li>
                                <li><a href="" readonly="true" data-curr-page="">当前第
                                    <sapn>${currPage} 总页数:${totalPage}</sapn>
                                    页</a></li>
                                <li><a href="javascript:" data-curr-page="${totalPage}"
                                       class="page">尾页</a></li>
									    <li><a href="javascript:"
                                       data-curr-page="${1 + currPage > totalPage ? totalPage : 1 + currPage}"
                                       class="page">&raquo;</a></li>
 `

                    $('#menuPage').empty().html(pag)
                        let sj=''
                        sj = `
                        <h3>搜索结果如下</h3>
                        `
                        $('#e').empty().html(sj)

                    }else{
                        let sj=''
                        sj = `
                        <h3>没有搜索结果</h3>
                        `
                        $('#e').empty().html(sj)

                    }
            }
            })
        });

        $('#menuPage').on('click','.page',function () {
            currPage = this.dataset.currPage
            console.log("123")
            let pageSize=8
            throttling()
        })
        function getQueryStringArgs() {
            const qs = location.search.length>0? location.search.substring(1):""
            let args ={}
            const items = qs.length?qs.split('&') : []
            let item = null
            let name = null
            let value = null
            items.forEach(el=>{
                item = el.split('=')
                name = decodeURIComponent(item[0])
                value = decodeURIComponent(item[1])
                if(name.length){
                    args[name]=value
                }
            })
            return args
        }
        let pag=''
        function dateFormat(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${d.getMonth() < 10 ? ('0' + d.getMonth()) : d.getMonth()}-${d.getDate() < 10 ? ('0' + d.getDate()) : d.getDate()} ${d.getHours() < 10 ? ('0' + d.getHours()) : d.getHours()}:${d.getMinutes() < 10 ? ('0' + d.getMinutes()) : d.getMinutes()}:${d.getSeconds() < 10 ? ('0' + d.getSeconds()) : d.getSeconds()}`
        }
        // window.onload = function () {
        //     let show = ''
        //     $.ajax({
        //         url: 'users/getLoginUser',
        //         method: 'GET',
        //         dataType: 'JSON',
        //         success(data) {
        //             //如果已经登录的话
        //             if (data.result) {
        //                 show = `<li class="dropdown loginlist" id="userInfo" style="width: 120px;">
        //                 <a href="#" style="position:relative;border-bottom: 5px solid transparent;padding-right: 90px;" class="dropdown-toggle" data-toggle="dropdown">
        //                     <span class="glyphicon glyphicon-user"></span><span style="margin-top: 10px;position:absolute;top:10px;width:100px">${data.t.userName}<b class="caret"></b></span>
        //                 </a>
        //                  <ul class="dropdown-menu" style="position: absolute; left: -1px;  background-color: #0000004d;">
        //                     <li style="border-bottom: 0 solid #fff;"><a href="userPage" style="color: #fff">个人中心</a></li>
        //
        //                     <li style="border-bottom: 0 solid #fff;"><a href="menuManage" style="color: #fff">发布菜谱</a></li>
        //
        //                     <li style="border-bottom: 0 solid #fff;"><a href="index" id="logout" style="color: #fff">退出登录</a></li>
        //                 </ul>
        //             </li>`
        //             } else {
        //                 show = `   <li><a href="login">登录/注册</a></li>     `
        //             }
        //             $('#isLogin').empty().html(show)
        //
        //         }
        //         // }
        //     })
        // }

        $('#isLogin').on('click','#logout',function () {

            $.ajax({
                url:'users/logout',
                dataType:'JSON',
                success(data){
                    if(data.result){

                        toast(data.msg+" 3秒之后自动跳转",'success')
                        setTimeout(
                            function () {
                                window.location.href="index"
                            },3000)

                    }else {
                        setTimeout(toast(data.msg))
                    }
                }
            })
        })

        let timeout;
        function throttling(){
            //先清理
            clearTimeout(timeout)
            timeout = setTimeout(() => {
                let pageSize=8

                $.ajax({
                    url: 'dishes/fuzzySearch',
                    method: 'POST',
                    data: {text,currPage,pageSize},
                    dataType:'JSON',
                    success(data) {
                        let content = ''

                        data.data.forEach(el => {
                            if (el.picturesInfoList != undefined) {
                                content += ` <div class="item wx">
                        <div class="menu-banner">
                            <a href="menuDetail?dishId=${el.dishId}"><img src="${el.picturesInfoList[0].picAddress}" alt="数据库没图给你们看" style=" width: 200px;height: 140px;top: 0;position: absolute;left: 0" ></a>
                            <div class="menu-info" style="overflow:hidden;text-overflow:ellipsis;word-break:keep-all;white-space:nowrap;">
                                <a href="menuDetail?dishId=${el.dishId}">文章名:${el.dishName}</a>  <a href="">作者:${el.userId}</a>
                                <br>
                                时间: ${dateFormat(el.dishCreateTime)}
                                <br>
                                简介    ${el.dishIntro}
                                <br>
                            </div>
                        </div>
                    </div>`
                                $('#regTa').empty().html(content)

                            } else {
                                content += ` <div class="item wx">
                            <div class="menu-banner">
                            <a href="menuDetail?dishId=${el.dishId}"><img src="" alt="数据库没图给你们看" style=" width: 200px;height: 140px;top: 0;position: absolute;left: 0" ></a>
                                    <div class="menu-info" style="overflow:hidden;text-overflow:ellipsis;word-break:keep-all;white-space:nowrap;">
                                        <a href="menuDetail?dishId=${el.dishId}">文章名:${el.dishName}</a>  <a href="">作者:${el.userId}</a>
                                         <br>
                                        时间: ${dateFormat(el.dishCreateTime)}
                                        <br>
                                        简介    ${el.dishIntro}
                                        <br>

                                </div>
                            </div>
                        </div>`
                                $('#regTa').empty().html(content)

                            }
                        })
                        let t=data.page.totalPage

                        const {totalPage, currPage} = data.page;
                        let pag = `        <li><a href="javascript:"
                                       data-curr-page="${currPage - 1 > 0 ? currPage - 1 : 1}"
                                       class="page">&laquo;</a></li>
				                <li><a href="javascript:" data-curr-page="1" class="page">首页</a></li>
                                <li><a href="" readonly="true" data-curr-page="">当前第
                                    <sapn>${currPage} 总页数:${totalPage}</sapn>
                                    页</a></li>
                                <li><a href="javascript:" data-curr-page="${totalPage}"
                                       class="page">尾页</a></li>
									    <li><a href="javascript:"
                                       data-curr-page="${ 1+currPage  > totalPage ? totalPage : 1+currPage}"
                                       class="page">&raquo;</a></li>
 `

                        $('#menuPage').empty().html(pag)


                    }
                })
            }, 500)
        }

    </script>
</body>
</html>
