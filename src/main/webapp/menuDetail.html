<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>菜谱展示</title>
    <style>
        .main {
            display: grid;
            width: 1223px;
            height: 100%;
            grid-template-columns: 903px 300px;
            grid-template-rows: 268px 592px;
            grid-template-areas: 'a b' 'a c' 'd e';
            gap: 20px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        .divBorder {
            border: 1px solid #E9E9E9;
        }

        .divBorder::-webkit-scrollbar { /*滚动条整体样式*/
            width: 10px; /*高宽分别对应横竖滚动条的尺寸*/
            height: 1px;
        }

        .divBorder::-webkit-scrollbar-thumb { /*滚动条里面小方块*/
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            background: #535353;
        }

        .divBorder::-webkit-scrollbar-track { /*滚动条里面轨道*/
            -webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            background: #EDEDED;
        }

        .article {
            width: 93%;
            margin: 0 auto;
        }

        #thumbs-up, #thumbs-upSuccess {
            width: 148px;
            height: 59px;
            background-color: #CAF982;
            color: black;
            border-radius: 30px;
            border: 0;
        }

        #words {
            font-family: Segoe Print;
            font-size: 15px;
            width: 80%;
            height: 180px;
            padding-top: 30px;
        }

        #userInfoBox {
            display: grid;
            width: 100%;
            height: 100%;
            grid-template-rows: 3fr 1fr;
        }

        #concern, #concerned {
            width: 80px;
            height: 35px;
            background-color: #CAF982;
            color: white;
            border: 1px solid #0079FE;
            border-radius: 10px;
        }

        .thumbnailItem {
            width: 80px;
            height: 61px;
            background-color: #E4E4E4;
            margin-bottom: 0;
        }

        .wordBold {
            font-size: 13px;
            font-family: 微软雅黑;
            font-weight: bold
        }

        .wordRegular {
            font-size: 13px;
            font-family: 微软雅黑;
            color: #999999;
        }

        .wordRegular2 {
            font-size: 13px;
            font-family: FontAwesome;
            color: #999999
        }

        .list {
            display: grid;
            width: 228px;
            grid-template-rows: repeat(6, 1fr);
        }

        .circle {
            border-radius: 50%;
            width: 3.5rem;
            height: 3.5rem;
            margin-right: 10px;
        }

        .collect {
            width: 120px;
            height: 40px;
            background-color: white;
            color: #999999;
            border: 1px solid #999999;
            border-radius: 20px;
        }

        .commentList {
            width: 840px;
            /*height: 125px;*/
            padding-top: 20px;
            padding-bottom: 10px;
        }

        .profilePicture {
            width: 50px;
            height: 50px;
            background-color: #cccccc;
        }

        .nickname {
            height: 25px;
            padding-left: 20px;
        }

        .comContent {
            height: 30px;
            padding-left: 20px;
        }

        .operation {
            margin-right: 50px;
            margin-top: 15px;
            display: block;
        }

        .edit {
            width: 770px;
            height: 100px;
            border: 1px solid #E9E9E9;
            margin-left: 20px;
        }

        #login, .release {
            width: 100px;
            height: 40px;
            background-color: white;
            border: 1px solid #E4E4E4;
            border-radius: 3px;
        }

        #back {
            width: 50px;
            height: 50px;
            position: fixed;
            background: url('static/images/goToTop.png') no-repeat;
            cursor: pointer;
            right: 85px;
            bottom: 10px;
        }

        a:hover {
            text-decoration: none;
            cursor: pointer;
        }

        .wordsHidden {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>

</head>

<body>
<div class="container-fluid" style="position: relative">
    <!--导航栏-->
    <div class="collapse navbar-collapse" id="example-navbar-collapse"
         style="width: 1460px;margin: auto;background-color: #c7f4b7;">
        <!--左边的首页等—-->
        <ul class="nav navbar-nav menulist navbar-left">
            <li><a href="index">首页</a></li>
            <li><a href="sortcook">菜单</a></li>
        </ul>
        <!--是否登录-->
        <ul class="nav navbar-nav navbar-right " id="isLogin" style="width:10%;">

        </ul>

        <form class="navbar-form navbar-right" role="search">
            <div class="form-group" style="height: 100%;margin-top: 0px">
                <label>
                    <input type="text" placeholder="请输入您要搜索的菜谱名称" name="dishName" class="form-control searchinput"
                           style="width: 224px;margin-top: 2px; border-radius: 15px!important;"/>
                </label>
                <a href="javascript:void(0)" style="color: #000;">
                    <img src="./static/images/icons/搜索.svg" alt="" class="searchimg">
                </a>
            </div>
        </form>
    </div>

    <!-- 主体 -->
    <div class="main" style="margin-bottom: 150px">

        <!-- 菜谱信息 -->
        <div style="grid-area: a;background-color: white;padding-top: 20px;overflow: auto" class="divBorder"
             id="dishContent">
            <div style="height: 75px;display: flex" class="article">
                <div style="float: right;width: 20%;text-align: right;padding-top: 10px" id="tuBtn">
                    <input type="button" value="" id="thumbs-up" style="display: none">
                    <input type="button" value="" id="thumbs-upSuccess" style="display: none">
                </div>
            </div>
        </div>

        <!-- 用户信息 -->
        <div style="grid-area: b;background-color: white;padding-top: 20px" class="divBorder" id="userInfoBox">
            <div id="userInfo2">

            </div>
            <div style="text-align: center;padding-top: 10px">
                <input type="button" value="关注" id="concern" style="display: inline">
                <input type="button" value="已关注" id="concerned" style="display: none">
            </div>
        </div>

        <!-- 热门作品 -->
        <div style="grid-area: c;background-color: white;padding:25px 35px" class="divBorder">
            <!-- 热门作品 更多 -->
            <div style="display: flex;justify-content: space-between;width: 228px;height: 48px;padding: 14px 15px"
                 class="divBorder">
                <div class="wordBold">热门作品</div>
                <a href="javascript:">
                    <div class="wordRegular2" id="hotMore">更多</div>
                </a>
            </div>

            <!-- 作品列表 -->
            <div class="list" style="height: 100%">
                <ul class="list-group" style="width: 228px" id="hotArticle">

                </ul>
            </div>
        </div>

        <!-- 评论 -->
        <div style="grid-area: d;background-color: white;padding-top: 10px" class="divBorder">
            <!-- 收藏 分享 -->
            <div style="height: 130px;" class="article">
                <!-- 发布时间 -->
                <div style="height: 53px;text-align: right;line-height: 53px;color: #999999;margin-bottom: 15px"
                     class="wordRegular" id="dishCreateTime">

                </div>
                <div style="display: flex;justify-content: space-between">
                    <!-- 分享 -->
                    <div>
                        <!-- 图标 -->
                        <div style="display: flex;padding-bottom: 10px">
                            <!-- 这边之后可以换成圆形图片 -->
                            <div class="circle"><img src="static/images/share/QQ.svg" height="30px"></div>
                            <div class="circle"><img src="static/images/share/wechat.svg" height="30px"></div>
                            <div class="circle"><img src="static/images/share/blog.svg" height="30px"></div>
                        </div>
                        <span class="wordRegular2">快给朋友分享吧！</span>
                    </div>
                    <!-- 收藏 -->
                    <div>
                        <!-- 收藏按钮 -->
                        <div style="text-align: center;padding-bottom: 10px">
                            <input type="button" value="收藏" class="collect wordRegular" id="collect"
                                   style="font-size: 14px;display: inline">
                        </div>
                        <!-- 收藏人数 -->
                        <div class="wordRegular2" style="text-align: center"><span id="collectCount">0</span>人收藏
                        </div>
                    </div>
                </div>
            </div>
            <hr/>
            <!-- 发布评论 -->
            <div class="article">
                <!-- 标题 -->
                <div style="height: 50px">
                    <span class="wordBold" style="font-size: 14px">发布评论</span>
                    <span class="wordRegular" style="font-size: 12px">文明上网理性发言，请遵守评论服务协议</span>
                </div>
                <!-- 编辑框 -->
                <!-- 分为未登录状态和已登录状态 -->
                <div style="display: flex" id="commentEditBox">

                </div>
            </div>
            <hr/>
            <!-- 全部评论 -->
            <div class="article">
                <div class="list-group" id="allComments">

                </div>
            </div>
        </div>

        <!-- 排行榜 -->
        <div style="grid-area: e;background-color: white;padding:25px 35px;height: 600px" class="divBorder">
            <!-- 排行榜 更多 -->
            <div style="display: flex;justify-content: space-between;width: 228px;height: 48px;padding: 14px 15px"
                 class="divBorder">
                <div class="wordBold">相关推荐</div>
                <a>
                    <div class="wordRegular2" id="aboutMore">更多</div>
                </a>
            </div>

            <!-- 作品列表 -->
            <div class="list" style="height: 100%">
                <ul class="list-group" style="width: 228px" id="aboutArticle">

                </ul>
            </div>
        </div>
    </div>

    <!--</div>-->
    <div class="footer">
        <div class="row">
            <div class="col-md-1" style="height: 100px;"></div>
            <div class="col-md-1" style="height: 100px;width: 100px">
                <img src="static/images/logo.png" alt="这是一个logo"
                     style=" width: 74px; height: 88px; margin-top: 7px;margin-left: 19px">
            </div>
            <div class="col-md-4" style="height: 100px;">
                <p class="footer_link">网站首页&nbsp;&nbsp;&nbsp;帮助中心&nbsp;&nbsp;&nbsp;联系我们&nbsp;&nbsp;&nbsp;客户服务&nbsp;&nbsp;&nbsp;隐私政策
                    &nbsp;&nbsp;&nbsp;意见反馈</p>
                <p>Copyright © 2020SUMMER All Rights Reserved.</p>
            </div>
            <div class="col-md-1" style="height: 100px;"></div>

            <div class="col-md-3" style="height: 100px;">
                <img class="pic qq" src="static/images/share/QQ.svg" alt="QQ">
                <img class="pic" src="static/images/share/wechat.svg" alt="wechat">
                <img class="pic" src="static/images/share/blog.svg" alt="blog">
            </div>
            <div class="col-md-2" style="height: 100px;"></div>
        </div>
    </div>

    <div id="back">
        <a href="javascript:" title="回到顶部"></a>
    </div>
</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <form id="collectForm">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel" style="text-align: center">添加到收藏夹</h4>
                </div>
                <!-- 所有收藏夹的信息 -->
                <div class="modal-body" id="allCollections">

                </div><!-- /.modal-content -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="submit" class="btn btn-primary" id="confirmBtn">确定</button>
                </div>
            </div><!-- /.modal -->
        </div>
    </form>
</div>

<link rel="stylesheet" href="./static/css/ace.min.css"/>
<link rel="stylesheet" type="text/css" href="./static/bootstrap-3.3.7-dist/css/bootstrap.css">
<link rel="stylesheet" href="./static/css/commons.css">
<link rel="stylesheet" href="./static/css/bootoast.css">
<script type="text/javascript" src="./static/js/jquery-3.3.1.js"></script>
<script type="text/javascript" src="./static/bootstrap-3.3.7-dist/js/bootstrap.js"></script>
<script src="./static/js/bootoast.js"></script>
<script src="./static/js/jquery.popconfirm.js"></script>
<script src="./static/js/uuid.js"></script>
<link rel="shortcut icon" href="./static/images/kaola.ico" type="image/x-icon"/>
<script src="./static/js/nav.js"></script>
<script>
    (function () {
        //回到顶部
        $(document).ready(function () {
            //首先将#btn隐藏
            $("#back").hide();
            //当滚动条的位置处于距顶部50像素以下时，跳转链接出现，否则消失
            $(function () {
                $(window).scroll(function () {
                    if ($(window).scrollTop() > 50) {
                        $("#back").fadeIn(200);
                    } else {
                        $("#back").fadeOut(200);
                    }
                });
                //当点击跳转链接后，回到页面顶部位置
                $("#back").click(function () {
                    $('body,html').animate({
                            scrollTop: 0
                        },
                        500);
                    return false;
                });
            });
        });

        //变量
        let dishId;//菜谱id
        let authorId;//作者用户的id
        let pageSize = 3;
        let currPage = 1;

        +function init() {
            //获取dishId
            getQueryStringArgs();
            // 是否登录显示不同的评论区域
            loginEdit();
            //显示菜谱内容
            showDish();
            //显示评论区
            showRootComments();
            //显示热门作品
            showHotArticle();
        }();

        //获取当前菜谱的id
        function getQueryStringArgs() {
            //取得查询字符串问号后参数字符串
            const qs = location.search.length > 0 ? location.search.substring(1) : "";
            //定义保存数据对象
            let args = {};
            //取得每一项
            const items = qs.length ? qs.split('&') : [];
            let item = null;
            let name = null;
            let value = null;
            items.forEach(el => {
                item = el.split('=');
                name = decodeURIComponent(item[0]);
                value = decodeURIComponent(item[1]);
                if (name.length) {
                    //将参数封装成键值对
                    args[name] = value
                }
            });
            //返回封装好的参数map
            dishId = args.dishId
        }

        //获取当前登录的用户信息
        function getLoginUserInfo() {
            return new Promise(function (resolve, reject) {
                $.ajax({
                    url: 'users/getLoginUser',
                    method: 'POST',
                    dataType: 'JSON',
                    success(data) {
                        if (data.result) {
                            resolve(data.t)
                        } else {
                            reject(data)
                        }
                    }
                })
            })
        }

        //获取菜谱内容
        function showDish() {
            new Promise((resolve, reject) => {
                $.ajax({
                    url: 'dishes/select/id',
                    method: 'POST',
                    data: {dishId},//发送菜谱id
                    dataType: 'JSON',
                    success(data) {//data.t是菜谱对象  里面有userId
                        let content = '';
                        let dishContext = '';
                        let dishReleaseTime = '';
                        if (data.result) {
                            content += `<div style="font-size: 32px;width: 80%;padding-top: 15px;" class="wordsHidden">${data.t.dishName}</div>`;
                            dishContext += `<div style="margin: 10px;padding-left: 40px;font-family: 楷体;font-size: 18px;color: #999999">${data.t.dishIntro}</div>
                                            <div style="margin: 20px">${data.t.dishText}</div>`;
                            dishReleaseTime += `<span class="wordRegular2">发布于 </span><span>${dateFormat(data.t.dishCreateTime)}</span>`;
                            //初始化收藏人数
                            const num = data.t.collectNumber;
                            $('#collectCount').empty().html(num);

                            authorId = data.t.userId;//作者的id
                            $('#tuBtn').before(content);
                            $('#dishContent').append(dishContext);
                            $('#dishCreateTime').empty().html(dishReleaseTime);
                            getUserInfoByDish();
                            resolve(data)
                        }
                    }
                });
            }).then(data2 => {
                new Promise((resolve, reject) => {
                    getLoginUserInfo().then(loginUser => {
                        $.ajax({
                            url: 'dishes/isLike',//判断是否已点赞的请求
                            method: 'POST',
                            data: {dishId: dishId, userId: loginUser.userId},
                            dataType: 'JSON',
                            success(data) {//data.t是用户信息
                                if (data.result) {//未点赞状态
                                    $('#thumbs-up').css('display', 'inline');
                                    $('#thumbs-up').val(`点赞 ${data2.t.likeNumber}`);
                                    $('#thumbs-upSuccess').css('display', 'none');
                                } else {//已点赞状态
                                    $('#thumbs-upSuccess').css('display', 'inline');
                                    $('#thumbs-upSuccess').val(`已点赞 ${data2.t.likeNumber}`);
                                    $('#thumbs-up').css('display', 'none');
                                }
                            },
                            error(data) {
                                console.log("shibai");
                                console.log(data)
                            }
                        });
                    }).catch(data => {
                        $('#thumbs-up').css('display', 'inline');
                        $('#thumbs-up').val(`点赞 ${data2.t.likeNumber}`);
                        $('#thumbs-upSuccess').css('display', 'none');
                    });
                    resolve(data2)
                }).then(data2 => {
                    //相关推荐
                    const d = {currPage: 1, pageSize: 6, id: data2.t.tagId, sortord: -7};
                    $.ajax({
                        url: 'dishes/sort',
                        method: 'POST',
                        data: d,
                        dataType: 'JSON',
                        success(data) {//data是菜谱对象list
                            let content = '';
                            if (data.result) {
                                data.data.forEach(el => {
                                    const {dishId, picturesInfoList, dishName, dishCreateTime, likeNumber} = el;
                                    if (picturesInfoList !== undefined) {
                                        const {picAddress} = picturesInfoList[0];
                                        content += `<a href="javascript:" class="aboutArticleItems" data-dish-id="${dishId}">
                                                <li class="list-group-item">
                                                    <div style="display: flex">
                                                        <div class="thumbnailItem"><img src=${picAddress} alt="无封面" width="80px" height="61px" /></div>
                                                        <div style="padding-left: 10px;overflow: hidden;" class="wordsHidden">
                                                            <div class="wordBold wordsHidden" style="color: #333333">${dishName}</div>
                                                            <div class="wordRegular">${dateFormat2(dishCreateTime)}</div>
                                                            <div class="wordRegular">人气：<span>${likeNumber}</span></div>
                                                        </div>
                                                    </div>
                                                </li>
                                            </a>`;
                                    }
                                })
                            }
                            $('#aboutArticle').empty().html(content)
                        }
                    })
                });
            })
        }

        //根据菜谱id获取作者信息
        function getUserInfoByDish() {
            let content = '';
            //发送ajax请求，获得用户名和用户头像
            $.ajax({
                url: 'users/search',
                method: 'POST',
                data: {userId: authorId},
                dataType: 'JSON',
                success(data) {//data是UserInfo对象
                    if (data.result) {
                        content = `<div>
                            <div style="width: 100px;height: 90px;background-color: #a6e1ec;margin: 10px auto"><img src="${data.t.userPicture == null ? '' : data.t.userPicture}" width="100px" height="90px" /></div>
                        </div>
                        <div style="text-align: center">
                            <p style="font-size: 18px;font-family: 微软雅黑;font-weight: bold">${data.t.userNickname == null ? '无名' : data.t.userNickname}</p>
                            <p style="font-size: 14px;font-family: 微软雅黑;">简介</p>
                        </div>`;
                    }
                    $('#userInfo2').empty().html(content);
                    isConcern()
                }
            });
        }

        //页面加载时判断是否关注
        function isConcern() {
            let content = '';
            getLoginUserInfo().then(loginUser => {
                const followedUserId = authorId;
                const userId = loginUser.userId;
                if (followedUserId != userId) {
                    $.ajax({
                        url: 'users/isFollow',//判断是否已关注的请求
                        method: 'POST',
                        data: {followedUserId: followedUserId, userId: userId},
                        dataType: 'JSON',
                        success(data) {//data.t是用户信息
                            if (data.result) {//未关注状态
                                $('#concern').css('display', 'inline');
                                $('#concerned').css('display', 'none')
                            } else {//已关注状态
                                $('#concern').css('display', 'none');
                                $('#concerned').css('display', 'inline')
                            }
                            $('#userInfo2').append(content)
                        },
                        error(data) {
                            console.log("shibai");
                            console.log(data)
                        }
                    })
                } else {
                    $('#concern').css('display', 'none');
                    $('#concerned').css('display', 'none')
                }
            })
        }

        // 是否登录显示不同的评论区域
        function loginEdit() {
            getLoginUserInfo().then(loginUser => {
                let content = `<div>
                        <div class="profilePicture"><img src="${loginUser.userPicture == null ? '' : loginUser.userPicture}" width="50px" height="50px"></div>
                    </div>
                    <div>
                        <div>
                            <input type="text" placeholder="在这里发布你的评论吧" class="edit wordRegular commentContent1">
                        </div>
                        <div style="width: 770px;height: 60px;display: flex;justify-content: right;margin-left: 20px;padding-top: 10px">
                            <div>
                                <div style="text-align: center;padding-bottom: 10px">
                                    <a href="javascript:"><input type="button" value="发布"
                                                                 class="wordRegular release" data-user-id="0"></a>
                                </div>
                            </div>
                        </div>
                    </div>`;
                $('#commentEditBox').empty().html(content)
            }).catch(data => {
                let content = `<div>
                        <div class="profilePicture"></div>
                        <div class="wordRegular"
                             style="font-size: 12px;width: 50px;height: 31px;text-align: center;padding-top: 10px">未登录
                        </div>
                    </div>
                    <div>
                        <div>
                            <input type="text" placeholder="登录后可以发表评论" class="edit wordRegular" disabled>
                        </div>
                        <div style="width: 770px;height: 60px;margin-left: 20px;padding-top: 10px">
                            <div>
                                <div style="text-align: right;padding-bottom: 10px">
                                    <a href="login"><input type="button" value="登录" class="wordRegular"
                                                                     id="login"></a>
                                </div>
                            </div>
                        </div>
                    </div>`;
                $('#commentEditBox').empty().html(content)
            })
        }

        //回复的编辑框
        function getReportEditBox(e) {
            const reportContent = `<div id="repeatComment" style="margin-top: 20px">
                                    <div>
                                        <div>
                                            <input type="text" placeholder="在这里发布你的评论吧" class="edit wordRegular commentContent" style="width: 650px">
                                        </div>
                                        <div style="width: 650px;height: 70px;display: flex;justify-content: right;margin-left: 20px;padding-top: 10px">
                                            <div>
                                                <div style="text-align: center;padding-bottom: 10px">
                                                    <a href="javascript:"><input type="button" value="发布"
                                                                                 class="wordRegular release" data-comment-id="${e.commentId}" data-user-id="${e.userId}"></a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
            return reportContent;
        }

        //显示根评论
        function showRootComments() {
            new Promise((resolve, reject) => {
                let modPage = (currPage - 1) * pageSize;
                $.ajax({
                    url: 'comments/get/rootComments',
                    method: 'POST',
                    data: {dishId, modPage, pageSize},
                    dataType: 'JSON',
                    success(data) {
                        if (data.result) {
                            let content = '';
                            let index = 0;
                            data.data.forEach(el => {
                                content += `<li class="list-group-item" id="${el.commentId}">
                            <div style="display: flex" class="commentList">
                                <div>
                                <div class="profilePicture"><img src="${el.userInfos.userPicture == null ? '' : el.userInfos.userPicture}" width="50px" height="50px"/></div>
                            </div>
                            <div>
                                <div style="margin-bottom: 10px">
                                <span class="wordRegular nickname" style="font-size: 14px;color: #666666">${el.userInfos.userNickname == null ? '无名' : el.userInfos.userNickname}</span>
                                <span class="wordRegular nickname" style="font-size: 12px;">${dateFormat(el.commentTime)}</span>
                            </div>
                            <p class="wordRegular comContent">${el.commentText}</p>
                            <div style="display: flex;padding-left: 20px">
                                <div><a href="javascript:" class="wordRegular operation report"
                                    style="font-size: 12px;" data-index-id="root${index}" data-comment-id="${el.commentId}" data-user-id="${el.userId}">回复</a></div>
                                <div><a href="javascript:" class="wordRegular operation more" style="font-size: 12px;" data-comment-id="${el.commentId}" data-son-box="son${index}">展开更多</a></div>
                            </div>
                            <div id="root${index}"></div>
                            <div id="son${index}"></div>
                            </div>
                            </div>
                            </li>`;
                                index++;
                            });
                            content += `<div class="row" style="position:relative;top: 20px;left: 390px">
                            <ul id="commentPage">
                            </ul>
                            </div>`;
                            $('#allComments').empty().html(content);
                            resolve(data);
                        } else {
                            let content = data.msg;
                            $('#allComments').html(content)
                        }
                    }
                })
            }).then(data => {
                listPage(data)
            })
        }

        //分页栏
        function listPage(data) {
            let pageBar = `<a href="javascript:" class="page" data-curr-page="1">首页</a>
                       <a href="javascript:" class="page" data-curr-page="${currPage - 1 > 0 ? currPage - 1 : 1}">上一页</a>
                       <span>当前第<span>${currPage}</span>页</span>
                       <a href="javascript:" class="page" data-curr-page="${currPage + 1 > data.page.totalPage ? data.page.totalPage : currPage + 1}">下一页</a>
                       <a href="javascript:" class="page" data-curr-page="${data.page.totalPage}">尾页</a>
                       <span>总<span>${data.page.totalPage}</span>页</span>`;
            $('#commentPage').empty().html(pageBar)
        }

        //分页点击事件
        $('#allComments').on('click', '.page', function () {
            //获取当前页号
            setTimeout(() => {
                currPage = $(this).data('currPage');
                showRootComments()
            }, 10)
        });

        //显示子评论
        function showChildComments(e, currPage) {
            const commentId = $(e).data('commentId');
            new Promise((resolve, reject) => {
                currPage = currPage || 1;
                const modPage = (currPage - 1) * pageSize;
                $.ajax({
                    url: 'comments/get/childComments',
                    method: 'POST',
                    data: {dishId, commentId, modPage, currPage, pageSize},
                    dataType: 'JSON',
                    success(data) {
                        if (data.result) resolve(data);
                        else {
                            let content = data.msg;
                            const sonBox = $(e).data('sonBox');
                            $(`#${sonBox}`).empty().html(content);
                        }
                    }
                })
            }).then((data) => {
                new Promise((resolve, reject) => {
                    let content = '';
                    let index = 0;
                    data.data.forEach(el => {
                        content += `<div style="display: flex;margin-top: 10px">
                                <div class="profilePicture"><img src="${el.userInfos.userPicture == null ? '' : el.userInfos.userPicture}" width="50px" height="50px"/></div>
                                <div>
                                    <div style="display: block;padding-left: 20px;">
                                        <span class="wordRegular" style="font-size: 14px;color: #666666">${el.userInfos.userNickname == null ? '无名' : el.userInfos.userNickname} </span>`;
                        //是否有父评论
                        if (el.parentUserId != commentId) {
                            content += `<span class="wordRegular" style="font-size: 14px;color: #666666">回复 <span>${el.parentInfos.userNickname == null ? '无名' : el.parentInfos.userNickname}</span></span>`
                        }
                        content += `<span class="wordRegular">：<span>${el.commentText}</span></span>
                            </div>
                            <div style="text-align: right;width: 650px">
                                <span class="wordRegular nickname" style="font-size: 12px;">${dateFormat(el.commentTime)}</span>
                                <a href="javascript:" class="wordRegular report"
                                   style="font-size: 12px;margin-left: 50px;margin-top: 15px" data-index-id="div${index}" data-comment-id="${commentId}" data-user-id="${el.userId}">回复</a>
                            </div>
                            <div id="div${index}"></div>
                            </div>
                            </div>`;
                        index++
                    });
                    content += `<div class="row" style="position:relative;top: 25px;left: 390px">
                            <ul id="childCommentPage${commentId}">
                            </ul>
                            </div>`;
                    const sonBox = $(e).data('sonBox');
                    $(`#${sonBox}`).empty().html(content);
                    resolve(data, commentId)
                }).then(data => {
                    childListPage(data, commentId)
                })
            })
        }

        //根评论展开更多点击事件
        $('#allComments').on('click', '.more', function () {
            setTimeout(() => {
                showChildComments(this)
            }, 10)
        });

        //子评论分页栏
        function childListPage(data, commentId) {
            let pageBar = `<a href="javascript:" class="childPage" data-comment-id="${commentId}" data-curr-page="1">首页</a>
                       <a href="javascript:" class="childPage" data-comment-id="${commentId}" data-curr-page="${data.page.currPage - 1 > 0 ? data.page.currPage - 1 : 1}">上一页</a>
                       <span>当前第<span>${data.page.currPage}</span>页</span>
                       <a href="javascript:" class="childPage" data-comment-id="${commentId}" data-curr-page="${data.page.currPage + 1 > data.page.totalPage ? data.page.totalPage : data.page.currPage + 1}">下一页</a>
                       <a href="javascript:" class="childPage" data-comment-id="${commentId}" data-curr-page="${data.page.totalPage}">尾页</a>
                       <span>总<span>${data.page.totalPage}</span>页</span>`;
            $(`#childCommentPage${commentId}`).empty().html(pageBar)
        }

        //子评论分页栏点击事件
        $(document).on('click', '.childPage', function () {
            const commentId = $(this).data('commentId');
            const e = $(`#${commentId}`).find('.more');
            const currPage = $(this).data('currPage');
            showChildComments(e, currPage)
        });

        //点击评论回复显示编辑框
        $('#allComments').on('click', '.report', function () {
            const userId = $(this).data('userId');//获取父元素的id
            const commentId = $(this).data('commentId');//获取根评论id
            const indexId = $(this).data('indexId');
            const info = {userId, commentId};
            $('[id^=div],[id^=root]').each((index, el) => {
                if (el.id !== indexId) {
                    $(`#${el.id}`).empty()
                }
            });
            if ($(`#${indexId}`).html() !== "") {
                return false
            }
            //获得编辑框
            const reportContent = getReportEditBox(info);
            //填入html
            $(`#${indexId}`).append(reportContent);
        });

        //自己发表评论
        function getCommentInfo1(e) {
            //气泡弹框信息提示
            $(e).popover({
                title: '提示',//标题
                trigger: 'manual',//触发方式
                content: '请输入你的评论内容',//提示内容
                placement: 'top',//位置
            });

            //获取父评论的userId
            const parentUserId = $(e).data('userId');
            //获取当前根评论id
            const commentId = generateUUID();
            //获取评论的内容
            const commentText = $('.commentContent1').val();
            //评论时间
            const commentTime = new Date().getTime();
            if (commentText == "") {
                $(e).popover('show');
                setTimeout(() => {//定时消失
                    $(e).popover('destroy')
                }, 2000)
            } else {
                getLoginUserInfo().then(loginUser => {
                    //调用方法 传递参数
                    setTimeout(() => {
                        releaseComment({
                            dishId,
                            parentUserId,
                            userId: loginUser.userId,
                            commentId,
                            commentText,
                            commentTime
                        })
                    }, 10);
                    $('.commentContent1').val("")
                }).catch(data => {
                    toast(data.msg, 'warning')
                })
            }
        }

        //评论区回复
        function getCommentInfo(e) {
            //气泡弹框信息提示
            $(e).popover({
                title: '提示',//标题
                trigger: 'manual',//触发方式
                content: '请输入你的评论内容',//提示内容
                placement: 'top',//位置
            });

            //获取父评论的userId
            const parentUserId = $(e).data('userId');
            //获取当前根评论id
            const commentId = $(e).data('commentId');
            //获取评论的内容
            const commentText = $('.commentContent').val();
            //评论时间
            const commentTime = new Date().getTime();
            if (commentText === "") {
                $(e).popover('show');
                setTimeout(() => {//定时消失
                    $(e).popover('destroy')
                }, 2000)
            } else {
                getLoginUserInfo().then(loginUser => {
                    //调用方法 传递参数
                    setTimeout(() => {
                        //发布评论
                        releaseComment({
                            dishId,
                            parentUserId,
                            userId: loginUser.userId,
                            commentId,
                            commentText,
                            commentTime
                        });
                    }, 10);
                    $('.commentContent').val("")
                }).catch(data => {
                    toast(data.msg, 'warning')
                })
            }
        }

        //发布按钮点击事件
        $('#allComments').on('click', '.release', function () {
            getCommentInfo(this)
        });

        //发布新的根评论
        $('#commentEditBox').on('click', '.release', function () {
            getCommentInfo1(this)
        });

        //发布评论的请求
        function releaseComment(e) {
            $.ajax({
                url: 'comments/insert',
                method: 'POST',
                data: e,
                dataType: 'JSON',
                success(data) {
                    if (data.result) {//插入成功
                        showRootComments();//重新加载评论区
                        toast(data.msg, 'success');
                    } else {//插入失败
                        toast(data.msg, 'warning')
                    }
                }
            });
            //默认展开当前评论的子评论
            const commentId = e.commentId;
            console.log('根评论id', commentId);
            if (commentId != undefined) {
                const ee = $(`#${commentId}`).find('.more');
                showChildComments(ee)
            }
        }

        //热门作品
        function showHotArticle() {
            const data = {currPage: 1, pageSize: 6, id: 0, sortord: -10};
            $.ajax({
                url: 'dishes/sort',
                method: 'POST',
                data: data,
                dataType: 'JSON',
                success(data) {//data是菜谱对象list
                    let content = '';
                    if (data.result) {
                        data.data.forEach(el => {
                            const {dishId, picturesInfoList, dishName, dishCreateTime, likeNumber} = el;
                            if (picturesInfoList !== undefined) {
                                const {picAddress} = picturesInfoList[0];
                                content += `<a href="javascript:" class="hotArticleItems" data-dish-id="${dishId}">
                                <li class="list-group-item">
                                    <div style="display: flex">
                                        <div class="thumbnailItem"><img src=${picAddress} alt="无封面" width="80px" height="61px" /></div>
                                        <div style="padding-left: 10px;" class="wordsHidden">
                                            <div class="wordBold wordsHidden" style="color: #333333">${dishName}</div>
                                            <div class="wordRegular">${dateFormat2(dishCreateTime)}</div>
                                            <div class="wordRegular">人气：<span>${likeNumber}</span></div>
                                        </div>
                                    </div>
                                </li>
                            </a>`
                            }
                        })
                    }
                    $('#hotArticle').empty().html(content)
                }
            })
        }

        //点赞按钮点击事件
        $('#thumbs-up').on('click', function () {
            setTimeout(() => {
                getLoginUserInfo().then(loginUser => {
                    $.ajax({
                        url: 'dishes/like',
                        method: 'POST',
                        data: {dishId: dishId, userId: loginUser.userId},
                        dataType: 'JSON',
                        success(data) {
                            if (data.result) {
                                toast(data.msg, 'success');
                                $('#thumbs-up').css('display', 'none');
                                $('#thumbs-upSuccess').css('display', 'inline');
                                $('#thumbs-upSuccess').val(`已点赞 ${data.page.sortord}`);
                            }
                        }
                    })
                }).catch(data => {
                    toast(data.msg, 'warning')
                })
            }, 10)
        });

        //取消点赞
        $('#thumbs-upSuccess').on('click', function () {
            setTimeout(() => {
                getLoginUserInfo().then(loginUser => {
                    $.ajax({
                        url: 'dishes/like',
                        method: 'POST',
                        data: {dishId: dishId, userId: loginUser.userId},
                        dataType: 'JSON',
                        success(data) {
                            if (data.result) {
                                toast(data.msg, 'success');
                                $('#thumbs-upSuccess').css('display', 'none');
                                $('#thumbs-up').css('display', 'inline');
                                $('#thumbs-up').val(`点赞 ${data.page.sortord}`);
                            }
                        }
                    })
                }).catch(data => {
                    const {msg} = data;
                    toast(msg, 'warning')
                })
            }, 10)
        });
        $('#thumbs-upSuccess').popConfirmThumbsup();

        //收藏按钮点击事件
        $('#collect').on('click', function () {
            setTimeout(() => {
                getLoginUserInfo().then(loginUser => {
                    const userId = loginUser.userId;//当前登录的用户userId
                    //获取收藏夹信息
                    $.ajax({
                        url: 'menus/getLoginUserMenus',
                        method: 'POST',
                        data: {userId},//发送的数据是userId
                        dataType: 'JSON',
                        success(data) {//data是收藏夹list
                            let content = '';
                            if (data.result) {
                                data.data.forEach(el => {
                                    //模态框内容
                                    content += `<div class="form-group row">
                        <div class="col-sm-1"></div>
                        <div class="col-sm-4">
                            <input type="checkbox" class="CollectCheckbox" id="${el.menuId}"><span style="padding-left: 20px">${el.menuName}</span>
                        </div>
                    </div>`
                                })
                            } else {
                                toast(data.msg, 'warning');
                                $('#collect').css('display', 'inline');
                                $('#collectSuccess').css('display', 'none')
                            }
                            $('#allCollections').empty().html(content);
                            $('#myModal').modal('show')
                        }
                    });
                }).catch(data => {
                    toast(data.msg, 'warning')
                })
            }, 10)
        });

        //收藏提交事件
        //点击确定 向后端发送菜谱id、收藏夹id、当前用户id
        $('#confirmBtn').on('click', function () {
            $(this).popover({
                title: '提示',//标题
                trigger: 'manual',//触发方式
                content: '请至少选择一个收藏夹',//提示内容
                placement: 'top',//位置
            });
            setTimeout(() => {
                if ($('#collectForm').find('input').length <= 0) {
                    $(this).popover('show');
                    setTimeout(() => {//定时消失
                        $(this).popover('destroy')
                    }, 2000)
                } else {
                    let collect = [];
                    //菜谱id dishId
                    //获取收藏夹id
                    $('#collectForm').find('input').each((index, el) => {
                        if (el.checked) {
                            let ob = {menuId: el.id, dishId: dishId};
                            collect.push(ob)
                        }
                    });
                    //收藏数组JSON为字符串
                    const JsonArr = JSON.stringify(collect);
                    $.ajax({
                        url: 'dishes/collect',
                        method: 'POST',
                        data: {collectArr: JsonArr},
                        dataType: 'JSON',
                        success(data) {
                            if (data.result) {
                                //更新收藏数
                                const num = data.page.sortord;
                                $('#collectCount').empty().html(num);
                                //清空表单数据
                                $('#collectForm')[0].reset();
                                //关闭模态框
                                $('#myModal').modal('hide');
                                toast(data.msg, 'success')
                            } else {
                                toast(data.msg, 'warning')
                            }
                        }
                    });
                }
            }, 10);
            return false
        });

        //关注按钮点击事件
        $('#concern').on('click', function () {
            getLoginUserInfo().then(loginUser => {
                setTimeout(() => {
                    const followedUserId = authorId;
                    const userId = loginUser.userId;//当前登录的用户id
                    $.ajax({
                        url: 'users/follow',
                        method: 'POST',
                        data: {followedUserId: followedUserId, userId: userId},
                        dataType: 'JSON',
                        success(data) {//data是一个ResultUtil对象
                            if (data.result) {
                                toast(data.msg, 'success');
                                //显示关注成功
                                $('#concern').css('display', 'none');
                                $('#concerned').css('display', 'inline')
                            }
                        }
                    })
                }, 10)
            }).catch(data => {
                toast(data.msg, 'warning')
            })
        });

        //取消关注
        $('#concerned').on('click', function () {
            setTimeout(() => {
                getLoginUserInfo().then(loginUser => {
                    const followedUserId = authorId;
                    const userId = loginUser.userId;//当前登录的用户id
                    $.ajax({
                        url: 'users/follow',
                        method: 'POST',
                        data: {followedUserId: followedUserId, userId: userId},
                        dataType: 'JSON',
                        success(data) {//data是一个ResultUtil对象
                            if (!data.result) {
                                toast(data.msg, 'success');
                                $('#concern').css('display', 'inline');
                                $('#concerned').css('display', 'none')
                            }
                        }
                    })
                }).catch(data => {
                    toast(data.msg, 'warning')
                })
            }, 10)

        });
        $('#concerned').popConfirmConcern();

        //热门作品点击事件
        $('#hotArticle').on('click', '.hotArticleItems', function () {
            setTimeout(() => {
                const dishId = $(this).data('dishId');
                window.location.href = `menuDetail?dishId=${dishId}`
            }, 10)
        });

        //相关推荐点击事件
        $('#aboutArticle').on('click', '.aboutArticleItems', function () {
            setTimeout(() => {
                const dishId = $(this).data('dishId');
                window.location.href = `menuDetail?dishId=${dishId}`
            }, 10)
        });

        //热门作品更多点击事件
        $('#hotMore').on('click', function () {
            window.location.href = "sortcook"
        });

        //相关推荐更多点击事件
        $('#aboutMore').on('click', function () {
            window.location.href = "sortcook"
        });

        //日期格式化
        function dateFormat(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${d.getMonth() + 1 < 10 ? ('0' + (d.getMonth() + 1)) : d.getMonth() + 1}-${d.getDate() < 10 ? ('0' + d.getDate()) : d.getDate()} ${d.getHours() < 10 ? ('0' + d.getHours()) : d.getHours()}:${d.getMinutes() < 10 ? ('0' + d.getMinutes()) : d.getMinutes()}:${d.getSeconds() < 10 ? ('0' + d.getSeconds()) : d.getSeconds()}`
        }

        //日期格式化
        function dateFormat2(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${d.getMonth() + 1 < 10 ? ('0' + (d.getMonth() + 1)) : d.getMonth() + 1}-${d.getDate() < 10 ? ('0' + d.getDate()) : d.getDate()}`
        }

        //提示样式
        function toast(message, type) {
            bootoast.toast({
                message: message,
                type: type,
                position: 'top-center',
                icon: null,
                timeout: 2,
                animationDuration: 300,
                dismissible: true
            });
        }

    })()
</script>
</body>

</html>